# Research Progress Refactoring - TODO List

**Date: 2025-08-23**

## ğŸ¯ **Project Goal**
Refactor research progress handling to achieve clear separation of concerns and integrate live SSE events.

## ğŸ“‹ **Current Status**
- âœ… **Phase 1 Complete**: ResearchProgressManager created and integrated
- âœ… **Phase 1 Tested**: New progress manager working with simulation
- âœ… **Phase 2 Complete**: Complete separation of concerns achieved
- âœ… **Phase 2.5 Part 1 Complete**: ResearchService integration (1,238 â†’ 975 lines)
- âœ… **Phase 2.5 Part 2 Complete**: SessionService extraction (975 â†’ 869 lines)
- âœ… **Phase 2.5 Part 3 Complete**: EventHandlerService extraction (869 â†’ 896 lines)
- âœ… **Phase 2.5 Part 4 Complete**: MessageService extraction (896 â†’ 601 lines)
- â³ **Phase 3 Pending**: Live SSE event integration

---

## ğŸš€ **Phase 1: Foundation Refactoring** âœ… COMPLETED
- [x] Create ResearchProgressManager class
- [x] Move progress simulation logic to manager
- [x] Comment out old code (conservative approach)
- [x] Test new implementation
- [x] Verify functionality works end-to-end

---

## ğŸ”§ **Phase 2: Complete Separation of Concerns** âœ… COMPLETED
- [x] **Move SSE event handling to ResearchProgressManager**
  - [x] Move `research_complete` event handler
  - [x] Move `progress_update` event handler  
  - [x] Move `collection_started` event handler
  - [x] Move `sources_found` event handler
  - [x] Move `research_findings` event handler

- [x] **Make ResearchProgress component self-contained**
  - [x] Move progress rendering logic to component
  - [x] Let component manage its own state
  - [x] Remove progress logic from Research.tsx

- [x] **Clean up Research.tsx**
  - [x] Remove all progress-related logic
  - [x] Focus only on research flow orchestration
  - [x] Keep only high-level state management

- [x] **Test Phase 2**
  - [x] Verify SSE events handled by manager
  - [x] Verify progress component self-contained
  - [x] Verify Research.tsx is clean

---

## ğŸ—ï¸ **Phase 2.5: Research.tsx File Size Reduction** ğŸ”„ IN PROGRESS
**Current Status**: Research.tsx is **1,238 lines** - needs reduction to <500 lines

### **Major Refactoring Opportunities Identified:**

#### **1. Extract Research Logic (300+ lines)** ğŸ”„ IN PROGRESS
- [x] **Create ResearchService class** - âœ… Created
- [x] **Extract startRealResearch function** - âœ… Moved to ResearchService
- [x] **Extract company data processing logic** - âœ… Moved to ResearchService
- [x] **Extract SSE event handling** - âœ… Moved to ResearchService
- [ ] **Update Research.tsx to use ResearchService** - ğŸ”„ PENDING
- [ ] **Test ResearchService integration** - ğŸ”„ PENDING

#### **2. Extract Session Management (100+ lines)** âœ… COMPLETE
- [x] **Create SessionService class** - âœ… COMPLETE
- [x] **Extract loadCompanyResearch function** (~100 lines) - âœ… COMPLETE
- [x] **Extract saveCurrentResearchSession function** - âœ… COMPLETE
- [x] **Extract session expiry handling logic** - âœ… COMPLETE
- [x] **Update Research.tsx to use SessionService** - âœ… COMPLETE

#### **3. Extract Event Handlers (100+ lines)** âœ… COMPLETE
- [x] **Create EventHandlerService class** - âœ… COMPLETE
- [x] **Extract handleCompanySelect function** (~100 lines) - âœ… COMPLETE
- [x] **Extract handleSendMessage function** (~100 lines) - âœ… COMPLETE
- [x] **Extract handleOptionClick function** - âœ… COMPLETE
- [x] **Update Research.tsx to use EventHandlerService** - âœ… COMPLETE

#### **4. Extract UI State Management** â³ PENDING
- [ ] **Create ResearchStateManager class**
- [ ] **Consolidate multiple useEffect hooks**
- [ ] **Extract state management logic**
- [ ] **Simplify Research.tsx state handling**

#### **5. Extract Export/Download Logic** â³ PENDING
- [ ] **Create ExportService class**
- [ ] **Extract handleDownloadReport function**
- [ ] **Extract handleExportResearch function**
- [ ] **Update Research.tsx to use ExportService**

### **Target File Structure:**
```
Research.tsx (target: <500 lines)
â”œâ”€â”€ State declarations (~50 lines)
â”œâ”€â”€ Service instantiations (~20 lines)
â”œâ”€â”€ useEffect hooks (~50 lines)
â”œâ”€â”€ Simple event handlers (~100 lines)
â”œâ”€â”€ UI rendering (~200 lines)
â””â”€â”€ Imports and exports (~30 lines)
```

### **New Service Files to Create:**
- [x] `src/services/ResearchService.ts` - âœ… Created (300+ lines extracted)
- [ ] `src/services/SessionService.ts` - â³ PENDING
- [ ] `src/services/EventHandlerService.ts` - â³ PENDING
- [ ] `src/services/ResearchStateManager.ts` - â³ PENDING
- [ ] `src/services/ExportService.ts` - â³ PENDING

### **Refactoring Methodology (Conservative Approach):**
1. **Create new service file** with extracted logic
2. **Comment out old code** in Research.tsx (keep as backup)
3. **Add new code** that uses the service
4. **Test thoroughly** to ensure functionality works
5. **Delete commented code** only after successful testing
6. **Git commit** the changes

### **Current Progress:**
- [x] **ResearchService created** - âœ… Done
- [x] **Comment out startRealResearch in Research.tsx** - âœ… Done
- [x] **Add ResearchService integration** - âœ… Done
- [x] **Test ResearchService integration** - âœ… Done (Tested via Playwright - working perfectly!)
- [x] **Delete commented startRealResearch code** - âœ… Done
- [x] **Git commit ResearchService integration** - âœ… Done

### **Phase 2.5 Results:**
- âœ… **Research.tsx reduced from 1,238 lines to 975 lines**
- âœ… **263 lines removed (21% reduction)**
- âœ… **ResearchService successfully integrated**
- âœ… **All functionality preserved and tested**

### **Next Steps - SessionService Extraction:**
- [ ] **Create SessionService class** - ğŸ”„ NEXT
- [ ] **Extract loadCompanyResearch function** (~72 lines)
- [ ] **Extract saveCurrentResearchSession function** (~43 lines)
- [ ] **Extract loadResearchHistory function** (~13 lines)
- [ ] **Extract session expiry handling logic** (~30 lines)
- [ ] **Update Research.tsx to use SessionService**
- [ ] **Test SessionService integration**
- [ ] **Delete commented session management code**
- [ ] **Git commit SessionService integration**

### **Detailed Refactoring Analysis - Phase 2.5 Part 2:**

#### **SessionService - High Priority (150+ lines)** ğŸ”¥
**Functions to extract:**
- `loadResearchHistory()` - 13 lines
- `loadCompanyResearch()` - 72 lines (lines 196-267)
- `saveCurrentResearchSession()` - 43 lines (lines 593-635)
- Session expiry handling in useEffect hooks - 30 lines
- Auto-save logic (currently commented out)

**Expected reduction**: ~150+ lines
**New file size**: ~825 lines

#### **Future Refactoring Opportunities:**
1. **EventHandlerService** - 120+ lines (handleSendMessage, handleOptionClick, handleCompanySelect)
2. **MessageService** - 80+ lines (message creation, formatting, state management)
3. **UIStateService** - 60+ lines (state consolidation, useEffect hooks)
4. **Export/DownloadService** - 30+ lines (export functions)
5. **CitationService** - 20+ lines (citation handling)

**Target**: Reduce Research.tsx from 975 lines to <500 lines

---

## âš¡ **Phase 3: Live SSE Event Integration** â³ PENDING
- [ ] **Replace simulation with live SSE events**
  - [ ] Update ResearchProgressManager to handle real SSE events
  - [ ] Remove simulation logic
  - [ ] Map SSE events to progress steps
  - [ ] Handle real-time progress updates

- [ ] **Test live integration**
  - [ ] Verify progress updates with real SSE data
  - [ ] Test error handling for SSE events
  - [ ] Verify smooth transition from simulation to live

---

## ğŸ§ª **Testing Checklist**
- [ ] New research session flow
- [ ] Existing session loading flow  
- [ ] Progress steps display correctly
- [ ] Company overview renders after completion
- [ ] Research topics appear properly
- [ ] No lingering progress messages
- [ ] Error handling works
- [ ] Performance is acceptable

---

## ğŸ“ **Git Commits Strategy**
1. **Commit Phase 1** - Foundation refactoring complete
2. **Commit Phase 2** - Separation of concerns complete  
3. **Commit Phase 3** - Live SSE integration complete
4. **Final commit** - Clean up and documentation

---

## ğŸ¯ **Success Criteria**
- [x] ResearchProgressManager handles all progress logic âœ…
- [x] Clear separation of concerns achieved âœ…
- [x] Progress component self-contained âœ…
- [ ] Research.tsx under 500 lines (currently 1,238 lines) ğŸ”„ IN PROGRESS
- [ ] Live SSE events working â³ PENDING
- [x] All existing functionality preserved âœ…
- [ ] Easy to maintain and extend ğŸ”„ IN PROGRESS

---

## ğŸ“š **Files Involved**
- `src/pages/Research.tsx` - Main research flow (target: <500 lines, currently 1,238)
- `src/components/research/ResearchProgressManager.tsx` - Progress logic & SSE handling âœ…
- `src/components/research/ResearchProgress.tsx` - Progress UI component âœ…
- `src/services/ResearchService.ts` - Research logic & SSE handling âœ…
- `src/services/SessionService.ts` - Session management (to be created)
- `src/services/EventHandlerService.ts` - Event handling (to be created)
- `src/services/ResearchStateManager.ts` - State management (to be created)
- `src/services/ExportService.ts` - Export/download logic (to be created)

---

**Last Updated: 2025-08-23**
**Status: Phase 2.5 In Progress - Research.tsx File Size Reduction**
