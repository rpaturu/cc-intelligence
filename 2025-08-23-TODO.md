# Research Progress Refactoring - TODO List

**Date: 2025-08-23**

## 🎯 **Project Goal**
Refactor research progress handling to achieve clear separation of concerns and integrate live SSE events.

## 📋 **Current Status**
- ✅ **Phase 1 Complete**: ResearchProgressManager created and integrated
- ✅ **Phase 1 Tested**: New progress manager working with simulation
- ✅ **Phase 2 Complete**: Complete separation of concerns achieved
- 🔄 **Phase 2.5 In Progress**: Research.tsx file size reduction (1,238 → <500 lines)
- ⏳ **Phase 3 Pending**: Live SSE event integration

---

## 🚀 **Phase 1: Foundation Refactoring** ✅ COMPLETED
- [x] Create ResearchProgressManager class
- [x] Move progress simulation logic to manager
- [x] Comment out old code (conservative approach)
- [x] Test new implementation
- [x] Verify functionality works end-to-end

---

## 🔧 **Phase 2: Complete Separation of Concerns** ✅ COMPLETED
- [x] **Move SSE event handling to ResearchProgressManager**
  - [x] Move `research_complete` event handler
  - [x] Move `progress_update` event handler  
  - [x] Move `collection_started` event handler
  - [x] Move `sources_found` event handler
  - [x] Move `research_findings` event handler

- [x] **Make ResearchProgress component self-contained**
  - [x] Move progress rendering logic to component
  - [x] Let component manage its own state
  - [x] Remove progress logic from Research.tsx

- [x] **Clean up Research.tsx**
  - [x] Remove all progress-related logic
  - [x] Focus only on research flow orchestration
  - [x] Keep only high-level state management

- [x] **Test Phase 2**
  - [x] Verify SSE events handled by manager
  - [x] Verify progress component self-contained
  - [x] Verify Research.tsx is clean

---

## 🏗️ **Phase 2.5: Research.tsx File Size Reduction** 🔄 IN PROGRESS
**Current Status**: Research.tsx is **1,238 lines** - needs reduction to <500 lines

### **Major Refactoring Opportunities Identified:**

#### **1. Extract Research Logic (300+ lines)** 🔄 IN PROGRESS
- [x] **Create ResearchService class** - ✅ Created
- [x] **Extract startRealResearch function** - ✅ Moved to ResearchService
- [x] **Extract company data processing logic** - ✅ Moved to ResearchService
- [x] **Extract SSE event handling** - ✅ Moved to ResearchService
- [ ] **Update Research.tsx to use ResearchService** - 🔄 PENDING
- [ ] **Test ResearchService integration** - 🔄 PENDING

#### **2. Extract Session Management (100+ lines)** ⏳ PENDING
- [ ] **Create SessionService class**
- [ ] **Extract loadCompanyResearch function** (~100 lines)
- [ ] **Extract saveCurrentResearchSession function**
- [ ] **Extract session expiry handling logic**
- [ ] **Update Research.tsx to use SessionService**

#### **3. Extract Event Handlers (100+ lines)** ⏳ PENDING
- [ ] **Create EventHandlerService class**
- [ ] **Extract handleCompanySelect function** (~100 lines)
- [ ] **Extract handleSendMessage function** (~100 lines)
- [ ] **Extract handleOptionClick function**
- [ ] **Update Research.tsx to use EventHandlerService**

#### **4. Extract UI State Management** ⏳ PENDING
- [ ] **Create ResearchStateManager class**
- [ ] **Consolidate multiple useEffect hooks**
- [ ] **Extract state management logic**
- [ ] **Simplify Research.tsx state handling**

#### **5. Extract Export/Download Logic** ⏳ PENDING
- [ ] **Create ExportService class**
- [ ] **Extract handleDownloadReport function**
- [ ] **Extract handleExportResearch function**
- [ ] **Update Research.tsx to use ExportService**

### **Target File Structure:**
```
Research.tsx (target: <500 lines)
├── State declarations (~50 lines)
├── Service instantiations (~20 lines)
├── useEffect hooks (~50 lines)
├── Simple event handlers (~100 lines)
├── UI rendering (~200 lines)
└── Imports and exports (~30 lines)
```

### **New Service Files to Create:**
- [x] `src/services/ResearchService.ts` - ✅ Created (300+ lines extracted)
- [ ] `src/services/SessionService.ts` - ⏳ PENDING
- [ ] `src/services/EventHandlerService.ts` - ⏳ PENDING
- [ ] `src/services/ResearchStateManager.ts` - ⏳ PENDING
- [ ] `src/services/ExportService.ts` - ⏳ PENDING

### **Refactoring Methodology (Conservative Approach):**
1. **Create new service file** with extracted logic
2. **Comment out old code** in Research.tsx (keep as backup)
3. **Add new code** that uses the service
4. **Test thoroughly** to ensure functionality works
5. **Delete commented code** only after successful testing
6. **Git commit** the changes

### **Current Progress:**
- [x] **ResearchService created** - ✅ Done
- [ ] **Comment out startRealResearch in Research.tsx** - 🔄 NEXT
- [ ] **Add ResearchService integration** - 🔄 NEXT
- [ ] **Test ResearchService integration** - 🔄 NEXT
- [ ] **Delete commented startRealResearch code** - ⏳ PENDING
- [ ] **Git commit ResearchService integration** - ⏳ PENDING

---

## ⚡ **Phase 3: Live SSE Event Integration** ⏳ PENDING
- [ ] **Replace simulation with live SSE events**
  - [ ] Update ResearchProgressManager to handle real SSE events
  - [ ] Remove simulation logic
  - [ ] Map SSE events to progress steps
  - [ ] Handle real-time progress updates

- [ ] **Test live integration**
  - [ ] Verify progress updates with real SSE data
  - [ ] Test error handling for SSE events
  - [ ] Verify smooth transition from simulation to live

---

## 🧪 **Testing Checklist**
- [ ] New research session flow
- [ ] Existing session loading flow  
- [ ] Progress steps display correctly
- [ ] Company overview renders after completion
- [ ] Research topics appear properly
- [ ] No lingering progress messages
- [ ] Error handling works
- [ ] Performance is acceptable

---

## 📝 **Git Commits Strategy**
1. **Commit Phase 1** - Foundation refactoring complete
2. **Commit Phase 2** - Separation of concerns complete  
3. **Commit Phase 3** - Live SSE integration complete
4. **Final commit** - Clean up and documentation

---

## 🎯 **Success Criteria**
- [x] ResearchProgressManager handles all progress logic ✅
- [x] Clear separation of concerns achieved ✅
- [x] Progress component self-contained ✅
- [ ] Research.tsx under 500 lines (currently 1,238 lines) 🔄 IN PROGRESS
- [ ] Live SSE events working ⏳ PENDING
- [x] All existing functionality preserved ✅
- [ ] Easy to maintain and extend 🔄 IN PROGRESS

---

## 📚 **Files Involved**
- `src/pages/Research.tsx` - Main research flow (target: <500 lines, currently 1,238)
- `src/components/research/ResearchProgressManager.tsx` - Progress logic & SSE handling ✅
- `src/components/research/ResearchProgress.tsx` - Progress UI component ✅
- `src/services/ResearchService.ts` - Research logic & SSE handling ✅
- `src/services/SessionService.ts` - Session management (to be created)
- `src/services/EventHandlerService.ts` - Event handling (to be created)
- `src/services/ResearchStateManager.ts` - State management (to be created)
- `src/services/ExportService.ts` - Export/download logic (to be created)

---

**Last Updated: 2025-08-23**
**Status: Phase 2.5 In Progress - Research.tsx File Size Reduction**
