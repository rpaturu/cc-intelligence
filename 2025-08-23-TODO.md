# Research Progress Refactoring - TODO List

**Date: 2025-08-23**

## üéØ **Project Goal**
Refactor research progress handling to achieve clear separation of concerns and integrate live SSE events.

## üìã **Current Status**
- ‚úÖ **Phase 2.5 Complete**: Research.tsx file size reduction (1,238 ‚Üí 601 lines, 51.5% reduction)
- ‚úÖ **Phase 3 Complete**: Live SSE event integration with improved timing
- ‚è≥ **Phase 4 In Progress**: Enhanced SSE Timing with API Gateway

## üéØ **Success Criteria**
- [x] ResearchProgressManager handles all progress logic ‚úÖ
- [x] Clear separation of concerns achieved ‚úÖ
- [x] Progress component self-contained ‚úÖ
- [x] Research.tsx under 500 lines (currently 601 lines) ‚úÖ
- [ ] Live SSE events working ‚è≥ PENDING
- [ ] Real SSE-driven progress updates ‚è≥ PENDING
- [x] All existing functionality preserved ‚úÖ
- [ ] Easy to maintain and extend üîÑ IN PROGRESS

---

## ‚ö° **Phase 3: Live SSE Event Integration** ‚è≥ PENDING
- [ ] **Replace simulation with live SSE events**
  - [ ] Update ResearchProgressManager to handle real SSE events
  - [ ] Remove simulation logic
  - [ ] Map SSE events to progress steps
  - [ ] Handle real-time progress updates

- [ ] **Test live integration**
  - [ ] Verify progress updates with real SSE data
  - [ ] Test error handling for SSE events
  - [ ] Verify smooth transition from simulation to live

---

## üöÄ **Phase 4: SSE Migration & Progress System** ‚è≥ PENDING

### **Phase 4.1: Infrastructure Setup**
- [ ] **Create Feature Flag System**
  - [ ] Add RESEARCH_FEATURE_FLAGS configuration
  - [ ] Create getResearchMode function
  - [ ] Test feature flag switching
  - [ ] Add environment-based overrides (FORCE_MOCK_RESEARCH)

- [ ] **Create Progress Mapping System**
  - [ ] Create SSEProgressMapper class
  - [ ] Map SSE events to progress steps for each research area
  - [ ] Add progress mappings for company_overview, decision_makers, etc.
  - [ ] Create getIconForEvent function

### **Phase 4.2: Progress System Migration**
- [ ] **Migrate Company Overview to Real SSE Progress**
  - [ ] Update ResearchProgressManager to use real SSE events
  - [ ] Replace simulated progress with SSE-driven progress
  - [ ] Test company_overview with real progress updates
  - [ ] Verify progress steps update based on actual SSE events

- [ ] **Create Progress System for New Research Areas**
  - [ ] Create ResearchProgressSystem class
  - [ ] Implement unified progress handling for all research areas
  - [ ] Support both SSE and mock progress modes
  - [ ] Create MockProgressManager for non-SSE areas

### **Phase 4.3: Research Handler Implementation**
- [ ] **Create Research Handler Factory**
  - [ ] Create IResearchHandler interface
  - [ ] Create MockResearchHandler class
  - [ ] Create SSEResearchHandler class
  - [ ] Create ResearchHandlerFactory class
  - [ ] Add fallback strategy for SSE failures

- [ ] **Update Research.tsx Integration**
  - [ ] Replace direct ResearchService usage with factory pattern
  - [ ] Test both mock and SSE handlers
  - [ ] Verify seamless switching between modes

### **Phase 4.4: Component Migration**
- [ ] **Migrate Decision Makers**
  - [ ] Add decision_makers progress mapping
  - [ ] Test with mock progress
  - [ ] Switch to SSE mode
  - [ ] Test with real SSE progress
  - [ ] Verify fallback to mock if SSE fails

- [ ] **Test Integration**
  - [ ] Test company_overview with real SSE progress
  - [ ] Test decision_makers with mock progress
  - [ ] Test decision_makers with SSE progress
  - [ ] Verify error handling and fallbacks

### **Phase 4.5: Documentation & Cleanup**
- [ ] **Update Documentation**
  - [ ] Document feature flag system
  - [ ] Document progress mapping system
  - [ ] Create migration guide for new research areas
  - [ ] Update API documentation

- [ ] **Remove Legacy Code**
  - [ ] Remove old simulation logic
  - [ ] Clean up unused imports
  - [ ] Update TODO documentation
  - [ ] Final testing and validation

---

## üß™ **Testing Checklist**
- [ ] New research session flow
- [ ] Existing session loading flow  
- [ ] Progress steps display correctly
- [ ] Company overview renders after completion
- [ ] Research topics appear properly
- [ ] No lingering progress messages
- [ ] Error handling works
- [ ] Performance is acceptable

---

## üìö **Files Involved**
- `src/pages/Research.tsx` - Main research flow (target: <500 lines, currently 601)
- `src/components/research/ResearchProgressManager.tsx` - Progress logic & SSE handling ‚úÖ
- `src/components/research/ResearchProgress.tsx` - Progress UI component ‚úÖ
- `src/services/ResearchService.ts` - Research logic & SSE handling ‚úÖ
- `src/services/SessionService.ts` - Session management ‚úÖ
- `src/services/EventHandlerService.ts` - Event handling ‚úÖ
- `src/services/MessageService.ts` - Message handling ‚úÖ

---

## üìù **Git Commits Strategy**
1. **Commit Phase 3** - Live SSE integration complete
2. **Commit Phase 4** - SSE migration complete
3. **Final commit** - Clean up and documentation

---

## üìö **Files Involved**
- `src/pages/Research.tsx` - Main research flow (target: <500 lines, currently 601)
- `src/components/research/ResearchProgressManager.tsx` - Progress logic & SSE handling ‚úÖ
- `src/components/research/ResearchProgress.tsx` - Progress UI component ‚úÖ
- `src/services/ResearchService.ts` - Research logic & SSE handling ‚úÖ
- `src/services/SessionService.ts` - Session management ‚úÖ
- `src/services/EventHandlerService.ts` - Event handling ‚úÖ
- `src/services/MessageService.ts` - Message handling ‚úÖ

---

## üìù **Git Commits Strategy**
1. **Commit Phase 3** - Live SSE integration complete
2. **Commit Phase 4** - SSE migration complete
3. **Final commit** - Clean up and documentation

---

**Last Updated: 2025-08-24**
**Status: Phase 3 Complete, Phase 4 In Progress - Enhanced SSE Timing**

---

## üîí **Security Decision: API Gateway vs Lambda Function URLs**

**Decision: Stick with API Gateway for SSE streaming**

**Reasons:**
- ‚úÖ **Better Security**: API keys, rate limiting, CORS control
- ‚úÖ **Existing Infrastructure**: No need to rebuild authentication
- ‚úÖ **Production Ready**: Current implementation is secure and functional
- ‚úÖ **Maintainable**: Leverages existing security patterns

**Current Approach:**
- Use API Gateway with SSE token validation
- Improve timing simulation within existing constraints
- Connect to real Step Function progress when possible
- Maintain security while enhancing user experience

**Next Steps:**
- Fix timing simulation to work properly with API Gateway
- Integrate with real Step Function progress states
- Enhance user experience without compromising security

---

## üìã **Completed Phases (Archived)**

### **‚úÖ Phase 1: Foundation Refactoring (COMPLETED)**
- Created ResearchProgressManager class
- Moved progress simulation logic to manager
- Tested new implementation end-to-end

### **‚úÖ Phase 2: Complete Separation of Concerns (COMPLETED)**
- Moved all SSE event handling to ResearchProgressManager
- Made ResearchProgress component self-contained
- Cleaned up Research.tsx

### **‚úÖ Phase 2.5: Research.tsx File Size Reduction (COMPLETED)**
- **ResearchService**: Extracted 300+ lines of research logic
- **SessionService**: Extracted 150+ lines of session management
- **EventHandlerService**: Extracted 120+ lines of event handling
- **MessageService**: Extracted 80+ lines of message handling
- **Total Reduction**: 1,238 ‚Üí 601 lines (51.5% reduction)

---

## ‚ö° **Phase 3: Live SSE Event Integration** ‚è≥ PENDING
- [ ] **Replace simulation with live SSE events**
  - [ ] Update ResearchProgressManager to handle real SSE events
  - [ ] Remove simulation logic
  - [ ] Map SSE events to progress steps
  - [ ] Handle real-time progress updates

- [ ] **Test live integration**
  - [ ] Verify progress updates with real SSE data
  - [ ] Test error handling for SSE events
  - [ ] Verify smooth transition from simulation to live

---

## üöÄ **Phase 4: SSE Migration & Progress System** ‚è≥ PENDING

### **Phase 4.1: Infrastructure Setup**
- [ ] **Create Feature Flag System**
  - [ ] Add RESEARCH_FEATURE_FLAGS configuration
  - [ ] Create getResearchMode function
  - [ ] Test feature flag switching
  - [ ] Add environment-based overrides (FORCE_MOCK_RESEARCH)

- [ ] **Create Progress Mapping System**
  - [ ] Create SSEProgressMapper class
  - [ ] Map SSE events to progress steps for each research area
  - [ ] Add progress mappings for company_overview, decision_makers, etc.
  - [ ] Create getIconForEvent function

### **Phase 4.2: Progress System Migration**
- [ ] **Migrate Company Overview to Real SSE Progress**
  - [ ] Update ResearchProgressManager to use real SSE events
  - [ ] Replace simulated progress with SSE-driven progress
  - [ ] Test company_overview with real progress updates
  - [ ] Verify progress steps update based on actual SSE events

- [ ] **Create Progress System for New Research Areas**
  - [ ] Create ResearchProgressSystem class
  - [ ] Implement unified progress handling for all research areas
  - [ ] Support both SSE and mock progress modes
  - [ ] Create MockProgressManager for non-SSE areas

### **Phase 4.3: Research Handler Implementation**
- [ ] **Create Research Handler Factory**
  - [ ] Create IResearchHandler interface
  - [ ] Create MockResearchHandler class
  - [ ] Create SSEResearchHandler class
  - [ ] Create ResearchHandlerFactory class
  - [ ] Add fallback strategy for SSE failures

- [ ] **Update Research.tsx Integration**
  - [ ] Replace direct ResearchService usage with factory pattern
  - [ ] Test both mock and SSE handlers
  - [ ] Verify seamless switching between modes

### **Phase 4.4: Component Migration**
- [ ] **Migrate Decision Makers**
  - [ ] Add decision_makers progress mapping
  - [ ] Test with mock progress
  - [ ] Switch to SSE mode
  - [ ] Test with real SSE progress
  - [ ] Verify fallback to mock if SSE fails

- [ ] **Test Integration**
  - [ ] Test company_overview with real SSE progress
  - [ ] Test decision_makers with mock progress
  - [ ] Test decision_makers with SSE progress
  - [ ] Verify error handling and fallbacks

### **Phase 4.5: Documentation & Cleanup**
- [ ] **Update Documentation**
  - [ ] Document feature flag system
  - [ ] Document progress mapping system
  - [ ] Create migration guide for new research areas
  - [ ] Update API documentation

- [ ] **Remove Legacy Code**
  - [ ] Remove old simulation logic
  - [ ] Clean up unused imports
  - [ ] Update TODO documentation
  - [ ] Final testing and validation

---

## üß™ **Testing Checklist**
- [ ] New research session flow
- [ ] Existing session loading flow  
- [ ] Progress steps display correctly
- [ ] Company overview renders after completion
- [ ] Research topics appear properly
- [ ] No lingering progress messages
- [ ] Error handling works
- [ ] Performance is acceptable

---

## üìù **Git Commits Strategy**
1. **Commit Phase 1** - Foundation refactoring complete
2. **Commit Phase 2** - Separation of concerns complete  
3. **Commit Phase 3** - Live SSE integration complete
4. **Final commit** - Clean up and documentation

---

## üéØ **Success Criteria**
- [x] ResearchProgressManager handles all progress logic ‚úÖ
- [x] Clear separation of concerns achieved ‚úÖ
- [x] Progress component self-contained ‚úÖ
- [ ] Research.tsx under 500 lines (currently 1,238 lines) üîÑ IN PROGRESS
- [ ] Live SSE events working ‚è≥ PENDING
- [x] All existing functionality preserved ‚úÖ
- [ ] Easy to maintain and extend üîÑ IN PROGRESS

---

## üìö **Files Involved**
- `src/pages/Research.tsx` - Main research flow (target: <500 lines, currently 1,238)
- `src/components/research/ResearchProgressManager.tsx` - Progress logic & SSE handling ‚úÖ
- `src/components/research/ResearchProgress.tsx` - Progress UI component ‚úÖ
- `src/services/ResearchService.ts` - Research logic & SSE handling ‚úÖ
- `src/services/SessionService.ts` - Session management (to be created)
- `src/services/EventHandlerService.ts` - Event handling (to be created)
- `src/services/ResearchStateManager.ts` - State management (to be created)
- `src/services/ExportService.ts` - Export/download logic (to be created)

---

**Last Updated: 2025-08-23**
**Status: Phase 2.5 In Progress - Research.tsx File Size Reduction**
