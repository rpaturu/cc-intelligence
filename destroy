#!/bin/bash

set -e;

# Load environment variables from .env.local if it exists
if [ -f .env.local ]; then
  source .env.local
fi

# Parse arguments
CDK_PROFILE=${AWS_PROFILE:-default}
CDK_REGION=${AWS_REGION:-us-west-2}
while [[ "$#" -gt 0 ]]; do case $1 in
  --profile) CDK_PROFILE="$2"; shift;;
  --region) AWS_REGION="$2"; shift;;
esac; shift; done

# Check if region is set
if [ -z "$AWS_REGION" ]; then
  # Try to get region from AWS config
  AWS_REGION=$(aws configure get region --profile $CDK_PROFILE 2>/dev/null)
  
  if [ -z "$AWS_REGION" ]; then
    echo "Error: AWS region is required"
    echo "Usage: ./destroy [--profile <aws_profile>] [--region <aws_region>]"
    echo "Example: ./destroy --profile dev --region us-west-2"
    echo "You may also configure your region by running 'aws configure'"
    exit 1
  fi
fi

echo "Using AWS Profile: $CDK_PROFILE"
echo "Using AWS Region: $AWS_REGION"

# Find existing stack
echo "Finding existing CcIntelligenceStack..."
STACK_NAME=$(aws cloudformation list-stacks \
  --profile $CDK_PROFILE \
  --region $AWS_REGION \
  --no-cli-pager \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE \
  --query "StackSummaries[?starts_with(StackName, 'CcIntelligenceStack')].StackName" \
  --output text | head -n 1)

if [ -z "$STACK_NAME" ]; then
  echo "No existing CcIntelligenceStack found."
  exit 0
fi

echo "Found stack: $STACK_NAME"
echo "This will destroy all resources including:"
echo "- S3 bucket for website hosting"
echo "- S3 bucket for CloudFront logs"
echo "- CloudFront distribution"
echo ""
read -p "Are you sure you want to continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Destruction cancelled."
  exit 1
fi

echo "Destroying stack..."
cd infrastructure
npx cdk --profile $CDK_PROFILE --region $AWS_REGION destroy --stack-name $STACK_NAME --force

cd ..

# Remove .env file if it exists
if [ -f .env ]; then
  echo "Removing .env file..."
  rm .env
fi

echo "Destruction complete! üóëÔ∏è" 